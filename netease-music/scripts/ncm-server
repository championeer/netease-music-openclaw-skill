#!/usr/bin/env bash
set -euo pipefail

# Simple server manager for NeteaseCloudMusicApi
# Usage:
#   ncm-server start [--port 3000]
#   ncm-server status
#   ncm-server stop

PORT=3000

while [[ $# -gt 0 ]]; do
  case "$1" in
    start|status|stop) CMD="$1"; shift ;;
    --port) PORT="$2"; shift 2;;
    *) echo "Unknown arg: $1"; exit 2;;
  esac
done

CMD=${CMD:-status}

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
RUNTIME_DIR="${NCM_RUNTIME_DIR:-"$ROOT_DIR/.ncm"}"
PID_FILE="$RUNTIME_DIR/server.pid"
LOG_FILE="$RUNTIME_DIR/server.log"
BASE_URL="${NCM_API_BASE:-"http://127.0.0.1:${PORT}"}"

mkdir -p "$RUNTIME_DIR"

is_up() {
  curl -fsS "$BASE_URL" >/dev/null 2>&1
}

case "$CMD" in
  status)
    if is_up; then
      echo "up: $BASE_URL"
      exit 0
    fi
    echo "down: $BASE_URL"
    exit 1
    ;;
  start)
    if is_up; then
      echo "already up: $BASE_URL"
      exit 0
    fi

    echo "starting NeteaseCloudMusicApi on port $PORT..."
    # Use npx to avoid global installs.
    # -y: auto-confirm
    # Note: NeteaseCloudMusicApi uses -p/--port in many versions; if it changes, adjust.
    nohup npx -y NeteaseCloudMusicApi@4.28.1 -p "$PORT" >"$LOG_FILE" 2>&1 &
    echo $! >"$PID_FILE"

    # wait briefly
    for i in {1..30}; do
      if is_up; then
        echo "up: $BASE_URL"
        exit 0
      fi
      sleep 0.2
    done

    echo "failed to start (see $LOG_FILE)"
    exit 1
    ;;
  stop)
    if [[ -f "$PID_FILE" ]]; then
      PID=$(cat "$PID_FILE" || true)
      if [[ -n "${PID:-}" ]]; then
        kill "$PID" >/dev/null 2>&1 || true
      fi
      rm -f "$PID_FILE"
    fi
    echo "stopped"
    ;;
esac
